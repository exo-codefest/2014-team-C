define("PORTLET/unified-search/QuicksearchPortlet",["SHARED/xss-utils","SHARED/jquery"],function(w,g){eXo.define.names=["XSSUtils","$"];eXo.define.deps=[w,g];return function(a){window.initQuickSearch=function(j,z,r){function s(b){a.getJSON("/rest/search/setting/quicksearch",function(a){b&&b(a)})}function m(b){b?(window.isSearching=!0,a(e).addClass("loadding"),a.browser.msie&&8==parseInt(a.browser.version,10)||(b=Math.min(a(h).width(),a(window).width()-a(e).offset().left-20),a(h).width(b)),a(h).show()):
window.isSearching=!1}function d(){var b=a(e).val();m(!0);var k=n.searchTypes.join(",");a.getJSON("/rest/search",{searchContext:{siteName:eXo.env.portal.portalName},q:b,sites:n.searchCurrentSiteOnly?eXo.env.portal.portalName:"all",types:k,offset:0,limit:n.resultsPerPage,sort:"relevancy",order:"desc"},function(A){var f=[];i=0;a.each(g,function(b,k){var c=A[k];if(c&&0!=a(c).size()){a.map(c,function(a){a.type=k});var e=[];a.each(c,function(a,b){i+=1;e.push(B(b,i))});c=C.replace(/%{type}/g,x[k].displayName).replace(/%{results}/g,
e.join(""));f.push(c)}});var d=0==f.length?D.replace(/%{query}/,w.sanitizeString(b)):E;a(h).html(F.replace(/%{resultRows}/,f.join("")).replace(/%{messageRow}/g,d));a.browser.msie&&8==parseInt(a.browser.version,10)||(d=Math.min(a(h).width(),a(window).width()-a(e).offset().left-20),a(h).width(d));a(h).show();a(e).removeClass("loadding");m(!1);d="/portal/"+eXo.env.portal.portalName+"/search";a(o).attr("href",d+"?q="+b+"&types="+k);c=0})}function B(b,c){var d=a(e).val().split(/\s+/g),f="";switch(b.type){case "event":f=
l.replace(/%{cssClass}/g,"uiIconPLFEvent uiIconPLFLightGray");break;case "task":f="uiIconPLFTask"+b.taskStatus.toProperCase()+" uiIconPLFLightGray";f=l.replace(/%{cssClass}/g,f);break;case "file":f=a.map(b.fileType.split(/\s+/g),function(a){return"uiIcon16x16"+a}).join(" ");f=l.replace(/%{cssClass}/g,f);break;case "document":f=a.map(b.fileType.split(/\s+/g),function(a){return"uiIcon16x16Template"+a}).join(" ");f=l.replace(/%{cssClass}/g,f);break;case "post":f=l.replace(/%{cssClass}/g,"uiIconPLFDiscussion uiIconPLFLightGray");
break;case "answer":f=l.replace(/%{cssClass}/g,"uiIconPLFAnswers uiIconPLFLightGray");break;case "wiki":f=l.replace(/%{cssClass}/g,"uiIconWikiWiki uiIconWikiLightGray");break;case "page":f=l.replace(/%{cssClass}/g,"uiIconEcmsTemplateDocument uiIconEcmsLightGrey");break;default:f=G.replace(/%{imageSrc}/g,b.imageUrl)}return H.replace(/%{index}/g,c).replace(/%{type}/g,b.type).replace(/%{lineResult}/g,f).replace(/%{url}/g,b.url).replace(/%{title}/g,(b.title||"").highlight(d)).replace(/%{excerpt}/g,(b.excerpt||
"").highlight(d)).replace(/%{detail}/g,(b.detail||"").highlight(d)).replace(/%{avatar}/g,"")}function I(a,c,e){if(8==a.keyCode&&c.trim()==e.trim()||46==a.keyCode&&c.trim()==e.trim())return!0}var x,g,n,e="#adminkeyword-"+j,t="#adminSearchLink-"+j,h="#quickSearchResult-"+j,o="#seeAll-"+j,J=a(e).val(),p=!1;window.isSearching=!1;var u=0,q=0,v=0,y="",i=0,c=0,K={"0":"48",1:"49",2:"50",3:"51",4:"52",5:"53",6:"54",7:"55",8:"56",9:"57",a:"65",b:"66",c:"67",d:"68",e:"69",f:"70",g:"71",h:"72",i:"73",j:"74",
k:"75",l:"76",m:"77",n:"78",o:"79",p:"80",q:"81",r:"82",s:"83",t:"84",u:"85",v:"86",w:"87",x:"88",y:"89",z:"90","numpad 0":"96","numpad 1":"97","numpad 2":"98","numpad 3":"99","numpad 4":"100","numpad 5":"101","numpad 6":"102","numpad 7":"103",backspace:"8","delete":"46"},H="        <div class='quickSearchResult %{type}' tabindex='%{index}' id='quickSearchResult%{index}'>         %{lineResult}      </div>",l="        <a href='%{url}'>      \t<i class='%{cssClass}'></i> %{title}     \t</a>",G="\t\t<a href='%{url}' class='avatarTiny'><img src='%{imageSrc}'/>%{title}</a>\t\t",
F="           <table class='uiGrid table table-striped  rounded-corners'>             <col width='30%'>             <col width='70%'>             %{resultRows}             %{messageRow}           </table>         ",C="           <tr>             <th>               %{type}             </th>             <td>               %{results}             </td>           </tr>         ",E="         <tr>           <td colspan='2' class='message'>             <a id='seeAll-"+j+"' class='' href='#'>"+z+"</a>           </td>         </tr>         ",
D="         <tr>           <td colspan='2' class='noResult'>             <span id='seeAll-"+j+"' class='' href='#'>"+r+" <strong>%{query}<strong></span>           </td>         </tr>         ";String.prototype.toProperCase=function(){return this.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})};String.prototype.highlight=function(a){for(var c=this,e=0;e<a.length;e++)""!=a[e]&&(c=c.replace(RegExp("(\\"+a[e]+")","gi"),"<strong>$1</strong>"));return c};a(document).on("click",
o,function(){window.location.href=a(this).attr("href");a(h).hide()});a(e).keyup(function(b){if(""==a(this).val())a(h).hide();else if(13==b.keyCode)a(o).click();else{var c=a(e).val();I(b,y,c)||a.each(K,function(c,f){if(f==b.keyCode){var k=a(e).val();q=(new Date).getTime();2>=k.length?d():1E3<=q-u?(u=q,d()):v++;2==v&&(v=0,d(),u=q)}y=a(e).val()})}});a(document).keyup(function(b){13==b.keyCode&&window.isSearching&&!a(e).is(":hidden")&&(p=!1,a(t).trigger("click"))});a(document).keyup(function(b){13==b.keyCode&&
!a(e).is(":hidden")&&(b=a("*:focus").attr("id"),0<c&&c<=i&&(b=a("#"+b+" .name").attr("href"),window.open(b,"_self")))});a(document).keyup(function(b){if(1<=i){if(40==b.keyCode&&!a(e).is(":hidden")){if(1<=c&&c<i){var d=a("#quickSearchResult"+c).attr("class").replace(" arrowResult","");a("#quickSearchResult"+c).attr("class",d)}c<i?(c+=1,a("#quickSearchResult"+c).focus(),d=a("#quickSearchResult"+c).attr("class")+" arrowResult",a("#quickSearchResult"+c).attr("class",d)):c==i&&a("#quickSearchResult"+i).focus()}38==
b.keyCode&&!a(e).is(":hidden")&&(1<c&&(d=a("#quickSearchResult"+c).attr("class").replace(" arrowResult",""),a("#quickSearchResult"+c).attr("class",d)),1<c?(c-=1,a("#quickSearchResult"+c).focus(),d=a("#quickSearchResult"+c).attr("class")+" arrowResult",a("#quickSearchResult"+c).attr("class",d)):1==c&&a("#quickSearchResult"+c).focus())}});a(t).click(function(){if(a(e).is(":hidden"))a(e).val(J),a(e).css("color","#555"),p=!0,a(e).show(),a(e).focus();else if(!0==p)a(e).hide(),a(h).hide();else if(window.isSearching){if(window.isSearching){var b=
a(e).val(),c=n.searchTypes.join(","),d="/portal/"+eXo.env.portal.portalName+"/search";a(t).attr("onclick","window.location.href='"+d+"?q="+b+"&types="+c+"'");window.isSearching=!1}}else a(o).click()});a(e).focus(function(){a(this).val("");a(this).css("color","#000");p=!1});a("body").click(function(b){0==a(b.target).parents("#ToolBarSearch").length&&(a(e).hide(),a(h).hide())});(function(b){a.getJSON("/rest/search/registry",function(a){b&&b(a)})})(function(a){x=a[0];g=a[1];s(function(a){n=a})})};window.initQuickSearchSetting=
function(j,g,r){function s(){var d=[];if(a(":checkbox[name='searchInOption'][value='all']").is(":checked"))return"all";a.each(a(":checkbox[name='searchInOption'][value!='all']:checked"),function(){d.push(this.value)});return 0==d.length?"false":d.join(",")}var m;a("#btnSave").click(function(){a.post("/rest/search/setting/quicksearch",{resultsPerPage:a("#resultsPerPage").val(),searchTypes:s(),searchCurrentSiteOnly:a("#searchCurrentSiteOnly").is(":checked")}).complete(function(a){alert("ok"==a.responseText?
g:r+a.responseText)})});a(":checkbox[name='searchInOption']").live("click",function(){"all"==this.value?a(this).is(":checked")?a(":checkbox[name='searchInOption']").attr("checked",!0):a(":checkbox[name='searchInOption']").attr("checked",!1):a(":checkbox[name='searchInOption'][value='all']").attr("checked",!1)});a.getJSON("/rest/search/registry",function(d){m=d[0];var g=[];g.push("      <div class='control-group'>         <div class='controls-full'>           <span class='uiCheckbox'>             <input type='checkbox' class='checkbox' name='%{name}' value='%{value}'>             <span>%{text}</span>           </span>         </div>       </div>     ".replace(/%{name}/g,
"searchInOption").replace(/%{value}/g,"all").replace(/%{text}/g,j));a.each(d[1],function(a,d){m[d]&&g.push("      <div class='control-group'>         <div class='controls-full'>           <span class='uiCheckbox'>             <input type='checkbox' class='checkbox' name='%{name}' value='%{value}'>             <span>%{text}</span>           </span>         </div>       </div>     ".replace(/%{name}/g,"searchInOption").replace(/%{value}/g,d).replace(/%{text}/g,m[d].displayName))});a("#lstSearchInOptions").html(g.join(""));
a.getJSON("/rest/search/setting/quicksearch",function(d){-1!=a.inArray("all",d.searchTypes)?a(":checkbox[name='searchInOption']").attr("checked",!0):(a(":checkbox[name='searchInOption']").attr("checked",!1),a.each(a(":checkbox[name='searchInOption']"),function(){-1!=a.inArray(this.value,d.searchTypes)&&a(this).attr("checked",!0)}));a("#resultsPerPage").val(d.resultsPerPage);a("#searchCurrentSiteOnly").attr("checked",d.searchCurrentSiteOnly)})})}}(g)});