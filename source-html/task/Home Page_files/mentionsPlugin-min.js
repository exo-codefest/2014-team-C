define("SHARED/mentionsPlugin",["SHARED/jquery","SHARED/mentionsLib"],function(A,B){eXo.define.names=["jQuery","mentions"];eXo.define.deps=[A,B];return function(d,k){var F,A,G,O,P,Q,C,R,H,B,ba;function na(){return{id:"",val:"",mentions:[],data:"",actionLink:{}}}F=8;A=9;G=13;O=37;P=38;Q=39;C=40;R=46;H=32;B=36;ba=35;var oa={triggerChar:"@",onDataRequest:d.noop,minChars:1,showAvatars:!0,firstShowAll:!1,selectFirst:!0,elastic:!0,elasticStyle:{maxHeight:"0px",minHeight:"0px",marginButton:"4px",enableMargin:!1},
idAction:"",actionLink:null,classes:{autoCompleteItemActive:"active"},cacheResult:{hasUse:!0,live:3E4},messages:{helpSearch:"Type to start searching for users.",searching:"Searching for ",foundNoMatch:"Found no matching users for "},templates:{wrapper:k.template('<div class="exo-mentions"></div>'),autocompleteList:k.template('<div class="autocomplete-menu"></div>'),autocompleteListItem:k.template('<li class="data" data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),
autocompleteListItemAvatar:k.template('<div class="avatarSmall"><img  src="<%= avatar %>" /></div>'),autocompleteListItemIcon:k.template('<div class="icon <%= icon %>"></div>'),mentionItemSyntax:k.template("<%=id%>"),mentionItemHighlight:k.template("<strong><span><%= value %></span></strong>")}},S=/(https?:\/\/)?((www\.[\w+]+\.[\w+]+\.?(:\d+)?)|([\w+]+\.[\w+]+\.?(\w+)?(:\d+)?))(\/\S*)?/g,h={htmlEncode:function(c){return k.escape(c)},highlightTerm:function(c,d){return!d&&!d.length?c:c.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+
d+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},rtrim:function(c){return c.replace(/\s+$/,"")},replaceFirst:function(c,d){for(;0===c.indexOf(d);)c=c.substring(1);return c},validateWWWURL:function(c){return 0<c.indexOf("www.")?/(https?:\/\/)?(www\.[\w+]+\.[\w+]+\.?(:\d+)?)/.test(c):!0},searchFirstURL:function(c){var d=(""+c).match(S);if(d&&0<d.length)for(var i=0;i<d.length;++i)if(0<d[i].length&&0>c.indexOf("@"+d[i])&&this.validateWWWURL(d[i]))return d[i];return""},removeLastBr:function(c){if(c){var d=
c.length;return 0<d&&(c=c.replace(/<br\/?>$/gi,""),d>c.length)?h.removeLastBr(c):c}return""},getSimpleValue:function(c){return c?(c=c.replace(/&amp;/g,"&").replace(/&nbsp;/g," ").replace(/<span.*?>/gi,"").replace(/<\/span>/gi,""),h.removeLastBr(c)):""},getCursorIndexOfText:function(c,d){for(var i=0,g=0;g<d.length;++g)if(c[g]===d[g])++i;else break;return 0<=i?i:-1},getIndexChange:function(d,h){for(var i={from:0<d.length?d.length:0,to:h.length},g=0;g<d.length;++g)if(d[g]!=h[g]){i.from=1<g?g-1:0;break}if(0<
d.length)for(var k=h.length-1,g=d.length-1;0<=g;--g){if(d[k]!=h[g]){i.to=k+1;break}--k}return i},isIE:!0===d.browser.msie,isFirefox:!0===d.browser.mozilla,brVersion:d.browser.version},aa=function(c){var s,i;function g(){var b=y();k.each(n,function(a){var e=c.templates.mentionItemSyntax(a);b=b.replace(a.value,e)});f.data("messageText",b)}function w(){l=[]}function S(){var b=y();n=k.reject(n,function(a){return!a.value||-1==b.indexOf(a.value)});n=k.compact(n)}function ca(b){var a=d.trim(f.value()),e=
c.triggerChar+t,e=0===a.indexOf(e)?"\\"+e:0<a.indexOf(">"+e)?"\\>"+e:"\\ "+e,p=RegExp(e,"gi");p.exec(a);e=p.lastIndex;p=a.substr(0,p.lastIndex-t.length-1);a=a.substr(e,a.length);n.push(b);w();t="";I();b=h.removeLastBr(p+J('<span contenteditable="false">'+b.value+'<i class="uiIconClose uiIconLightGray"'+(h.isFirefox?'contenteditable="true"':"")+">x</i></span>",-1,!1)+'<span class="none point"></span>'+a);f.val(b);b=f.find("span.point");da(b);b.remove();ea();z(f)}function J(b,a,e){b=d.trim(b);e=" "+
(e&&!0===e?c.triggerChar+T:T);return 0==a?d.trim(e)+b:0>a?b+e:d.trim(b.substring(0,a))+e+d.trim(b.substring(a,b.length))}function ea(){var b=f.find("> span");0<b.length&&d.each(b,function(b,e){var p=d(e).find("i");p.data("indexMS",{indexMS:b}).off("click");p.on("click",function(b){var a=d(this).data("indexMS").indexMS;n.splice(a,1);a=d(this).parent();f.find(".cursorText").remove();d('<div class="cursorText"></div>').insertAfter(a);var e=document.createTextNode(c.triggerChar);d(e).insertAfter(a);da(a);
a.remove();g();D();ea();b.stopPropagation();U(f);z(f)});d(e).on("click",function(){fa(this)})})}function K(){var b=null;if(window.getSelection)b=window.getSelection();else if(document.getSelection)b=document.getSelection();else if(document.selection)b=document.selection;return b}function z(b){if(null!=b&&0<b.length){var a=b.find(".cursorText");0!=b.val().length&&K()&&(a.attr("contenteditable","true").css({display:"inline",height:"14px"}).html("&nbsp;&nbsp;&nbsp;"),fa(a[0]));a.remove();b.focus();g()}}
function fa(b){try{if(b)if(b.focus(),document.selection)var a=document.selection.createRange();else{a=document.createRange();a.selectNode(b);a.selectNodeContents(b);var e=K();e.removeAllRanges();e.addRange(a)}}catch(d){window.console&&window.console.log&&window.console.log(d)}}function da(b){f.find("span.none").remove();var a=document.createElement("span");d(a).insertAfter(b);d(a).addClass("none");V(a,0)}function y(){return d.trim(f.val())}function aa(){var b=d(this),b=ga[b.attr("data-uid")];ca(b);
D();return!1}function pa(){var b=d.trim(f.value());f.animate({cursor:"wait"},50,function(){var a=d.trim(f.value()),e=h.getIndexChange(b,a);if(0<=a.indexOf('<img src="data:image/'))f.val(b.substring(0,e.from)+'<div class="cursorText"></div>'+b.substring(e.from)),z(f);else{var c=a.substr(e.from,e.to),j=d("<div/>").html(c).text();j.length<c.length&&(j=j.replace(/</gi,"&lt;").replace(/>/gi,"&gt;"),a=a.substr(0,e.from)+j+" "+T+a.substr(e.to),f.val(a),z(f));ha(j);f.css("cursor","text");E()}})}function qa(b){0<
m.find("li").length?(z(f),ia()):(b.stopPropagation(),w(),V())}function ra(){I(!1);if(0<m.find("li").length){f.find(".cursorText").remove();var b=f.value(),a=l.join(""),e=d.trim(a);t=e.replace(c.triggerChar,"");l=e.split("");0<b.indexOf(a)&&(a=" "+a,e=" "+e);b=b.replace(a,e+'<div class="cursorText"></div>');f.val(b)}D();0===y().length&&W()}function L(){if(!u){u=!0;g();S();l=h.replaceFirst(l.join("")," ").split("");var b=k.lastIndexOf(l,c.triggerChar);if(0===b){if(!1===x){var a=f.value(),e=h.getCursorIndexOfText(r,
a);if(0<e&&(a=a.substring(e-1,e),!(" "===a||""===a||"&nbsp;"===a||">"===a)))return}t=l.slice(b+1).join("");t=h.removeLastBr(t);l=(""+(c.triggerChar+t)).split("");b=t;("undefined"===typeof b||""===d.trim(b))&&!c.firstShowAll?M("",null):b.length>=c.minChars&&(c.cacheResult.hasUse?(a=b,a="result"+(" "===a?"_20":a),e=f.parent().data("CaseSearch"),(a="undefined"===""+e?e:e[a])?M(b,a):ja(b),sa()):ja(b))}else I()}}function ta(b){b=b.which||b.keyCode;if(b!==F&&b!==O&&b!==Q&&b!==R&&b!==P&&b!==C){var a=String.fromCharCode(b);
b===G&&(l=[],a=" ");l.push(a)}E()}function ua(b){u=!1;h.isIE&&f.find(".cursorText").remove();r=f.value();if((b.keyCode==O||b.keyCode==Q)&&!1===x||b.keyCode==B||b.keyCode==ba)k.defer(w),-1<navigator.userAgent.indexOf("MSIE 9")&&k.defer(g);else if(b.keyCode==F)h.isIE&&(1<l.length||1==l.length&&9>h.brVersion?L(b):I());else{h.isIE&&n.length&&g();if(!m.is(":visible"))return!0;switch(b.keyCode){case P:case C:if(0<m.find("li.msg").length)return!1;var a=null;b.keyCode==C?v&&v.length?(a=v.next(),0==a.length&&
(a=m.find("li:first"))):a=m.find("li").first():(a=d(v).prev(),0==a.length&&(a=m.find("li:last")));a.length&&X(a);u=!0;return!1;case G:case A:return v&&v.length?v.trigger("mousedown"):(a=d.Event("keydown",{keyCode:C}),d(this).trigger(a)),b.stopPropagation(),u=!0,!1}return!0}}function va(b){V();var a=f.value(),e=r.length-a.length,p=b.keyCode===F||b.keyCode===R,j=!0;if(1<e&&!0===x||!1===x&&1==e&&p){e=r;j=a;a="";0<ka()&&(a=s.textContent.substr(0,i));0>=a.length&&(e=h.getCursorIndexOfText(e,j),a=j.substring(0,
e),j=j.substring(e,j.length),0<j.length&&(e=j.indexOf(" "),p=j.indexOf("<br>"),e=0<e&&e<p?e:p,e=0>e?j.length:e,j=j.substring(0,e),a+=d.trim(j)));a:{if(a&&0<a.length&&0<=a.indexOf(c.triggerChar)&&(a=a.substring(a.indexOf(c.triggerChar)),j=a[a.length-1].charCodeAt(),0>a.indexOf(" ")&&0>a.indexOf("&nbsp;")&&0>a.indexOf("<")&&32!==j&&159!==j&&164!==j&&160!==j)){a=a.split("");break a}a=!1}!1!=a?(l=a,u=!1,r="",L()):w();j=!1}else!0===p?63<e&&!h.isFirefox?(e=h.getCursorIndexOfText(r,a),0<=e&&0===d.trim(r.substr(e)).toLowerCase().indexOf("<span")&&
(a=J(a,e,!0),f.val(a),U(f),!1===h.isIE&&z(f),j=!1)):1==e&&(e=l.join(""),a=la(r,a,e),a=0>=a?l.length-1:a,l.splice(a,1),u=!1):-1===e&&x&&(e=l.join(""),0>a.indexOf(e)&&(a=la(r,a,e),0<a&&a<e.length?(l.splice(a,0,l[l.length-1]),l.pop(),j=u=!1):w()));b.keyCode===H&&(!1===x||j&&(0<m.find("li.msg").length||0<=l.join().indexOf("  ")))&&w();h.isFirefox&&(a=K(),a=d(a.focusNode),a.is("i")&&a.hasClass("uiIconClose")&&a.trigger("click"));L();if((b=b.which||b.keyCode)&&b===H)b=d.trim(f.value()),ha(b);0===f.val().length?
W():E()}function la(b,a,e){a=h.getCursorIndexOfText(b,a);b=b.indexOf(e.substring(0,e.length-1));return a-b}function ha(b){if(o.isRun&&o.hasNotLink&&(o.linkSaved=h.searchFirstURL(b),o.linkSaved&&0<o.linkSaved.length&&(b=o.actionLink,b=d("string"===typeof b?"#"+b:b),0<b.length))){var a=d("#InputLink");if(0<a.length)o.hasNotLink=!1,D(),a.val(o.linkSaved),b.trigger("click")}}function U(){E();w();l[0]=c.triggerChar;r="";u=!1;L()}function I(b){b||null==b||void 0==b?(v=null,Y().empty()):Y()}function X(b){b.addClass(c.classes.autoCompleteItemActive);
b.siblings().removeClass(c.classes.autoCompleteItemActive);v=b}function wa(b){var a=d(this);X(a);b.stopPropagation()}function Z(b,a){d('<li class="msg"></li>').html("<em>"+a+"</em>").appendTo(b).on("click mousedown",function(b){b.stopPropagation();b.preventDefault()})}function ia(){x=!0;return m.show()}function Y(){x=!1;return m.hide()}function M(b,a){ia();m.empty();var e=d("<ul>").appendTo(m).hide();""===b&&!c.firstShowAll&&Z(e,c.messages.helpSearch);""!=b&&"searching"===a&&Z(e,c.messages.searching+
" <strong>"+b+"</strong>.");if((null===a||void 0===a||0===a.length)&&""!=b)" "!=l[l.length-1]?Z(e,c.messages.foundNoMatch+" <strong>"+b+"</strong>."):(w(),Y());a&&0<a.length&&"searching"!=a&&(""!=b||c.firstShowAll)&&k.each(a,function(a,f){var i=k.uniqueId("mention_");ga[i]=k.extend({},a,{value:a.name});i=d(c.templates.autocompleteListItem({id:h.htmlEncode(a.id),display:h.htmlEncode(a.name),type:h.htmlEncode(a.type),content:h.highlightTerm(h.htmlEncode(a.name),b)+" ("+a.id.replace("@","")+")"})).attr("data-uid",
i);0===f&&c.selectFirst&&X(i);c.showAvatars&&(a.avatar?d(c.templates.autocompleteListItemAvatar({avatar:a.avatar})):d(c.templates.autocompleteListItemIcon({icon:a.icon}))).prependTo(i);i.appendTo(e)});e.show()}function $(){f.val("");n=[];g()}function ja(b){M(b,"searching");c.onDataRequest.call(this,"search",b,function(a){M(b,a);var e=b;if(c.cacheResult.hasUse){var e="result"+(" "===e?"_20":e),d=f.parent().data("CaseSearch");"undefined"===""+d&&(d={});d[e]=a;f.parent().data("CaseSearch",d)}})}function sa(){f.parent().stop().animate({cursor:"default"},
c.cacheResult.live,function(){d(this).data("CaseSearch",{})})}function D(){var b=q.attr("id");if(b){var a=q.parents("form:first").parent();if(0<a.length){var e=a.data(b);null==e&&(e=new na);e.mentions=n;e.val=d.trim(f.value());e.data=0<n.length?f.data("messageText"):y();e.actionLink=o;a.data(b,e)}}}function xa(){var b=q.parents("form:first").parent(),a=q.attr("id");if(a)b=b.data(a),null==b?$():(n=b.mentions,f.val(b.val),f.data("messageText",b.data),o=b.actionLink,g())}function ya(b,a){var e="Display"+
b,c=a.find("#"+e);0===c.length&&(c=d('<div contenteditable="'+(d.browser.webkit?"plaintext-only":"true")+'" g_editable="true" class="replaceTextArea editable"></div>').attr("id",e),c.appendTo(a));c.val=function(a){if(null===a||"undefined"===typeof a)return a=d(this).clone(),a.find("span").find("i").remove(),a.find(".cursorText").remove(),h.getSimpleValue(a.html());"object"===typeof a?d(this).html("").append(a):d(this).html(a)};c.value=function(){var a=d(this).clone();a.find("span.none").remove();
var b=a.html();a.remove();return b=b.replace(/&amp;/g,"&").replace(/&nbsp;/g," ")};return c}function W(){f.parent().find("div.placeholder:first").show().css("top","5px");var b=0<d("#LinkTitle").length,a=d("#"+c.idAction);!1===b&&0<a.length&&void 0===a.attr("disabled")&&d("#"+c.idAction).attr("disabled","disabled").addClass("DisableButton")}function E(){f.parent().find("div.placeholder:first").hide().css("top","-100px");var b=d("#"+c.idAction);0<b.length&&"disabled"===b.attr("disabled")&&b.removeAttr("disabled").removeClass("DisableButton")}
function ka(){if(null===s)return null===i?-1:i;if("object"===typeof s){if(s===f[0])return i;for(var b=d("<div/>"),a=f[0].childNodes,e=0;e<a.length;++e){var c=a[e];if(c===s)break;else b.append(d(c).clone())}return e=b.html().length+i}return-1}function V(b,a){if(b&&"number"===typeof a)s=b,i=a;else{f.find("span.none").remove();var e=K(),c=e.anchorNode;if(c&&(c===f[0]||c.parentNode===f[0]))s=c,i=c===f[0]?h.removeLastBr(f.value()).length:e.baseOffset?e.baseOffset:e.anchorOffset?e.anchorOffset:0}try{if(d.browser.msie){var j=
document.selection,g=j.createRange(),l=g.parentElement(),g=g.duplicate(),k=f.value();g.moveEnd("character",k.length);""==g.text||k.lastIndexOf(g.text);g=j.createRange().duplicate();g.moveStart("character",-k.length);var m=g.htmlText;if(null!=m){m=(""+m).replace(/ id\=/," id_=").replace(/jQuery/g,"jq");if(0<m.indexOf("</"))var n=d(m),m=0<n.length?n.find(".ReplaceTextArea").html():m;s=l;i=null!=m?m.length:-1}}}catch(o){window.console&&window.console.log&&window.console.log(o)}}var q,f,ma,m,N,v,r="",
n=[],ga={},l=[],t="",T='<div class="cursorText"></div>'+(!1===h.isIE?"&nbsp;":"");s=null;i=0;var x=!1,u=!1,o={isRun:!1,actionLink:null,hasNotLink:!0,linkSaved:""},c=d.extend(!0,{},oa,c);c.triggerChar.charCodeAt(0);o.isRun=c.actionLink&&0<c.actionLink.length;o.actionLink=c.actionLink;return{init:function(b){window.jq=d;q=d(b);q.css({visibility:"hidden",display:"none"});q.val("");f=ya(q.attr("id"),q.parent());"true"!=f.attr("data-mentions")&&(ma=f.parent(),N=d(c.templates.wrapper()),f.wrapAll(N),N=
ma.find("> div"),f.attr("data-mentions","true"),f.on("keydown",ua),f.on("keypress",ta),f.on("keyup",va),f.on("click",qa),f.on("paste",pa),f.on("blur",ra),c.elastic&&f.elastic(c));m=d(c.templates.autocompleteList());m.appendTo(N);m.on("mousedown","li.data",aa);m.on("mouseover","li.data",wa);xa();b=1*(""+(new Date).getTime()).substring(10)+1;f.attr("tabindex",b);c.prefillMention&&ca(c.prefillMention);if(c.idAction&&0<c.idAction.length){var a=d("#"+c.idAction);a.on("mousedown keydown",function(a){a.stopPropagation();
if(!d(this).hasClass("DisableButton")){if("keydown"===a.type){var b=a.which||a.keyCode;if(b!==G&&b!==H)return}"mousedown"===a.type&&2===a.button||(a.preventDefault(),a=n.length?f.data("messageText"):y(),a=a.replace(/<br\/?>/gi,"\n").replace(/&lt;/gi,"<").replace(/&gt;/gi,">"),q.val(a),a=q.parents("form:first").parent(),(b=q.attr("id"))&&null!=a.data(b)&&a.data(b,null),$(),d.globalEval(d(this).data("actionLink")))}});a.attr("disabled","disabled").addClass("DisableButton");var e=(""+a.attr("onclick")).replace("javascript:",
"");a.attr("data-action-link",e);a.removeAttr("onclick");a.data("actionLink",e);a.attr("tabindex",b+1)}b=q.attr("title");0<d.trim(b).length&&(a=f.parent().find(".placeholder"),0==a.length?(a=d('<div class="placeholder">'+b+"</div>"),a.appendTo(f.parent())):a.html(b),a.off("click").on("click",function(){f.focus()}),0<y().length?E():W());if(c.actionMention&&0<c.actionMention.length&&(b=null,"string"===typeof c.actionMention?b=d("#"+c.actionMention):"object"===typeof c.actionMention&&(b=d(c.actionMention)),
b&&0<b.length))b.on("click",function(a){a.stopPropagation();a=f.value();if(0>a.indexOf('class="cursorText"')){var b=ka(),a=0==a.length||7>h.brVersion||void 0==b||0>b?J(a.replace(/&nbsp;/g," "),-1,!0).replace(/&nbsp;/,""):J(a,b,!0);f.val(a);U(f);z(f)}})},val:function(b){if(k.isFunction(b)){var a=n.length?f.data("messageText"):y();b.call(this,a)}},clearLink:function(){o.hasNotLink=!0;o.linkSaved="";D()},showButton:function(){var b=d("#"+c.idAction);0<b.length&&"disabled"===b.attr("disabled")&&b.removeAttr("disabled").removeClass("DisableButton")},
reset:function(){$()},getMentions:function(b){k.isFunction(b)&&b.call(this,n)}}};d.fn.extend({elastic:function(c){if((elasticStyle=c.elasticStyle)&&"object"===typeof elasticStyle&&0<parseInt(elasticStyle.maxHeight))return this.each(function(){var c=parseInt(elasticStyle.maxHeight)-parseInt(elasticStyle.minHeight);d(this).css({height:elasticStyle.minHeight,marginBottom:c+elasticStyle.marginButton+"px"});0<c&&(d(this).data("elasticStyle",{maxHeight:elasticStyle.maxHeight,minHeight:elasticStyle.minHeight,
marginButton:elasticStyle.marginButton,enableMargin:""+elasticStyle.enableMargin,delta:c}),d(this).on("focus keyup",function(){var c=d(this).data("elasticStyle");if(d(this).height()<parseInt(c.maxHeight)){var g={height:c.maxHeight};"true"===c.enableMargin&&(g={height:c.maxHeight,marginBottom:c.marginButton});d(this).animate(g,100,function(){})}}).on("blur",function(){var c=d.trim(d(this).html()),c=h.getSimpleValue(c);if(0==c.length){var c=d(this).data("elasticStyle"),g={height:c.minHeight};"true"===
c.enableMargin&&(g={height:c.maxHeight,marginBottom:c.delta+parseInt(c.marginButton)+"px"});d(this).animate(g,300,function(){})}}))})}});d.fn.exoMentions=function(c,h){var i=arguments;if("object"===typeof c||!c)h=c;return this.each(function(){var g=d.data(this,"exoMentions")||d.data(this,"exoMentions",new aa(h));if(k.isFunction(g[c]))return g[c].apply(this,Array.prototype.slice.call(i,1));if("object"===typeof c||!c)return g.init.call(this,this);d.error("Method "+c+" does not exist")})}}(A,B._)});